name: Deploy Full Stack con API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Compilar y probar el backend
  build-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: âœ… Checkout
      uses: actions/checkout@v3

    - name: ğŸ“¦ Setup .NET 10
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '10.0.x'

    - name: ğŸ”§ Restaurar
      run: dotnet restore PersonasAPI/PersonasAPI.csproj

    - name: ğŸ—ï¸ Compilar
      run: dotnet build PersonasAPI/PersonasAPI.csproj -c Release

    - name: ğŸ“¦ Publicar
      run: dotnet publish PersonasAPI/PersonasAPI.csproj -c Release -o ./publish

    - name: ğŸ“¤ Subir artefacto
      uses: actions/upload-artifact@v3
      with:
        name: dotnet-publish
        path: ./publish

  # Job 2: Desplegar frontend a GitHub Pages
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-backend
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: âœ… Checkout
      uses: actions/checkout@v3

    - name: ğŸ“ Preparar contenido para Pages
      run: |
        mkdir -p dist
        
        # Copiar web
        cp -r web/* dist/ 2>/dev/null || true
        
        # Crear pÃ¡gina de inicio
        cat > dist/README.html <<'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Personas API - GitHub Pages</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
                h1 { color: #333; }
                .info { background: #e7f3ff; border-left: 4px solid #0066cc; padding: 15px; margin: 10px 0; }
                a { color: #0066cc; text-decoration: none; }
                a:hover { text-decoration: underline; }
                code { background: #f0f0f0; padding: 2px 6px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ‘¥ GestiÃ³n de Personas - API REST</h1>
                
                <div class="info">
                    <h3>ğŸš€ En Vivo en GitHub Pages</h3>
                    <p>Compilado y desplegado automÃ¡ticamente con GitHub Actions</p>
                </div>

                <h2>ğŸ”— NavegaciÃ³n</h2>
                <ul>
                    <li><a href="index.html">ğŸ“± Interfaz CRUD</a></li>
                    <li><a href="config.html">âš™ï¸ Configurar API</a></li>
                </ul>

                <div class="info">
                    <h3>ğŸ“¡ Configurar Backend</h3>
                    <p>Como GitHub Pages solo aloja contenido estÃ¡tico, el backend debe correrse por separado:</p>
                    <ul>
                        <li><strong>Local:</strong> <code>http://localhost:5265</code></li>
                        <li><strong>ProducciÃ³n:</strong> Railway, Render, Vercel, etc.</li>
                    </ul>
                </div>

                <div class="info">
                    <h3>ğŸ“š DocumentaciÃ³n</h3>
                    <p>Consulta los archivos README en el repositorio para mÃ¡s informaciÃ³n.</p>
                </div>
            </div>
        </body>
        </html>
        EOF

    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v3

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: 'dist'

    - name: ğŸš€ Deploy to Pages
      id: deployment
      uses: actions/deploy-pages@v2

  # Job 3: NotificaciÃ³n
  notify:
    runs-on: ubuntu-latest
    needs: [build-backend, deploy-frontend]
    if: always()

    steps:
    - name: âœ¨ Resumen del despliegue
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘          âœ… DESPLIEGUE COMPLETADO                      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Œ Frontend (GitHub Pages):"
        echo "   https://utn-frp-tup-aplicada-2025.github.io/Ejemplos_gitpages/"
        echo ""
        echo "ğŸ“Œ Backend (requiere despliegue externo):"
        echo "   ğŸ”· ASP.NET: dotnet run"
        echo "   âš¡ Node.js: npm start"
        echo ""
        echo "ğŸ“Œ PrÃ³ximos pasos:"
        echo "   1. Desplegar backend en Railway/Render/Vercel"
        echo "   2. Configurar URL en el frontend"
        echo "   3. Â¡Usar la aplicaciÃ³n!"
