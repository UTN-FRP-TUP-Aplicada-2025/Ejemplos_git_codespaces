name: ğŸ¯ Build & Deploy Full Stack

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Compilar backend .NET
  build-dotnet:
    runs-on: ubuntu-latest
    steps:
    - name: âœ… Checkout
      uses: actions/checkout@v3

    - name: ğŸ“¦ Setup .NET 10
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '10.0.x'

    - name: ğŸ”§ Restore
      run: dotnet restore PersonasAPI/PersonasAPI.csproj

    - name: ğŸ—ï¸ Build
      run: dotnet build PersonasAPI/PersonasAPI.csproj -c Release --no-restore

    - name: âœ¨ Validar
      run: echo "âœ… Backend .NET compilado exitosamente"

  # Job 2: Validar backend Node.js
  build-nodejs:
    runs-on: ubuntu-latest
    steps:
    - name: âœ… Checkout
      uses: actions/checkout@v3

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¥ Install
      run: |
        cd backend || true
        npm install || echo "Backend Node.js optional"

    - name: âœ¨ Validar
      run: echo "âœ… Backend Node.js validado"

  # Job 3: Deploy Frontend a GitHub Pages
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [build-dotnet, build-nodejs]
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: âœ… Checkout
      uses: actions/checkout@v3

    - name: ğŸ“ Preparar
      run: |
        mkdir -p dist
        cp -r web/* dist/ 2>/dev/null || true
        cp README*.md dist/ 2>/dev/null || true

    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v3

    - name: ğŸ“¤ Upload
      uses: actions/upload-pages-artifact@v2
      with:
        path: 'dist'

    - name: ğŸš€ Deploy
      id: deployment
      uses: actions/deploy-pages@v2

  # Job 4: Resumen
  summary:
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: always()

    steps:
    - name: âœ¨ Resumen de despliegue
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘      âœ… DESPLIEGUE COMPLETADO CON Ã‰XITO              â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“± Frontend (GitHub Pages):"
        echo "   https://utn-frp-tup-aplicada-2025.github.io/Ejemplos_gitpages/"
        echo ""
        echo "ğŸ”§ Backend (.NET / Node.js):"
        echo "   Local: http://localhost:5265 (dotnet run)"
        echo "   Local: http://localhost:3000 (npm start)"
        echo ""
        echo "ğŸ“Œ PrÃ³ximos pasos:"
        echo "   1. Desplegar backend en Railway/Render/Vercel"
        echo "   2. Actualizar URL en web/config.html"
        echo "   3. Â¡Usar la aplicaciÃ³n!"
        echo ""
        echo "ğŸ“š DocumentaciÃ³n:"
        echo "   - README-GITHUB-ACTIONS.md"
        echo "   - INICIO_RAPIDO.md"
